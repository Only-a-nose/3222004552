| 这个作业属于哪个课程 |      https://edu.cnblogs.com/campus/gdgy/CSGrade22-34/       |
| :------------------: | :----------------------------------------------------------: |
|  这个作业要求在哪里  | https://edu.cnblogs.com/campus/gdgy/CSGrade22-34/homework/13229 |
|    这个作业的目标    |                      个人项目——论文查重                      |

## 一. PSP表格

| *PSP2.1*                                | *Personal Software Process Stages*      | *预估耗时（分钟）* | ***实际耗时（分钟）*** |
| :-------------------------------------- | :-------------------------------------- | ------------------ | :--------------------- |
| Planning                                | 计划                                    | 60                 | 65                     |
| · Estimate                              | · 估计这个任务需要多少时间              | 900                | 1200                   |
| Development                             | 开发                                    | 100                | 60                     |
| · Analysis                              | · 需求分析 (包括学习新技术)             | 100                | 100                    |
| · Design Spec                           | · 生成设计文档                          | 50                 | 40                     |
| · Design Review                         | · 设计复审                              | 50                 | 45                     |
| · Coding Standard                       | · 代码规范 (为目前的开发制定合适的规范) | 60                 | 40                     |
| · Design                                | · 具体设计                              | 60                 | 50                     |
| · Coding                                | · 具体编码                              | 60                 | 50                     |
| · Code Review                           | · 代码复审                              | 40                 | 30                     |
| · Test                                  | · 测试（自我测试，修改代码，提交修改）  | 40                 | 45                     |
| Reporting                               | 报告                                    | 50                 | 50                     |
| · Test Repor                            | · 测试报告                              | 60                 | 50                     |
| · Size Measurement                      | · 计算工作量                            | 30                 | 25                     |
| · Postmortem & Process Improvement Plan | · 事后总结, 并提出过程改进计划          | 30                 | 30                     |
|                                         | · 合计                                  |                    |                        |



## 二. 模块设计与接口文档

### 模块概述

该模块实现了一个用于计算文本文件之间相似度的工具。它使用 TF-IDF (Term Frequency-Inverse Document Frequency) 和余弦相似度方法来计算文本相似度，并且能够处理HTML格式的文本。模块包含以下几个主要组件：

1. **`CosineSimilarity`**: 计算两个文本的余弦相似度。
2. **`process_files`**: 处理多个文件对，计算相似度并写入结果文件。
3. **`TestCosineSimilarity`**: 对 `CosineSimilarity` 类进行单元测试。

### 模块结构

#### 1. `consineSimilarity` 类

##### 1.1 设计目的

`consineSimilarity` 类用于计算两个文本之间的余弦相似度，使用 TF-IDF 向量化方法。

##### 1.2 构造函数

```python
def __init__(self, content_x1, content_y2):
    """
    初始化 CosineSimilarity 类。

    :param content_x1: 第一个文本的内容。
    :param content_y2: 第二个文本的内容。
    """
    self.s1 = content_x1
    self.s2 = content_y2
```

- **参数说明**:
  - `content_x1`: 第一个文本的内容（字符串）。
  - `content_y2`: 第二个文本的内容（字符串）。

##### 1.3 方法

- **`extract_text(content)`**:
  
  ```python
  @staticmethod
  def extract_text(content):
      """
      从文本中提取纯文本，去除HTML标签并解码HTML实体。
  
      :param content: 包含HTML的文本字符串。
      :return: 纯文本字符串。
      """
      re_exp = re.compile(r'(<style>.*?</style>)|(<[^>]+>)', re.S)
      content = re_exp.sub(' ', content)
      content = html.unescape(content)
      return content.strip()
  ```

  - **参数说明**:
    - `content`: 包含HTML标签的文本。
  - **返回值**:
    - 去除HTML标签和解码HTML实体后的纯文本。

- **`main()`**:
  
  ```python
  def main(self):
      """
      计算两个文本之间的余弦相似度。
  
      :return: 两个文本之间的余弦相似度得分（0.0到1.0之间）。
      """
      text_x = self.extract_text(self.s1)
      text_y = self.extract_text(self.s2)
  
      if not text_x or not text_y:
          return 0.0
  
      vectorizer = TfidfVectorizer(stop_words='english')
      tfidf_matrix = vectorizer.fit_transform([text_x, text_y])
      sim_matrix = cosine_similarity(tfidf_matrix[0:1], tfidf_matrix[1:2])
      return sim_matrix[0][0]
  ```

  - **返回值**:
    - 余弦相似度得分，表示文本之间的相似度（0.0表示完全不同，1.0表示完全相同）。

#### 2. `process_files` 函数

##### 2.1 设计目的

`process_files` 函数处理多个文件对，计算每对文件之间的相似度，并将结果写入指定的输出文件。

##### 2.2 函数定义

```python
def process_files(file_pairs, outputfile):
    """
    处理文件对并将相似度结果写入输出文件。

    :param file_pairs: 文件对的列表，每对包含两个文件路径。
    :param outputfile: 输出结果文件的路径。
    """
    os.makedirs(os.path.dirname(outputfile), exist_ok=True)

    with open(outputfile, 'a+', encoding='utf-8') as answer:
        for file1, file2 in file_pairs:
            if not os.path.isfile(file1) or not os.path.isfile(file2):
                print(f"Error: One or both input files '{file1}' and '{file2}' do not exist.")
                continue

            try:
                with open(file1, 'r', encoding='utf-8') as f1, \
                        open(file2, 'r', encoding='utf-8') as f2:

                    content1 = f1.read()
                    content2 = f2.read()
                    similarity = CosineSimilarity(content1, content2)
                    similarity_score = similarity.main()
                    result = f'{file1} 和 {file2} 相似度: {similarity_score * 100:.2f}%\n'
                    answer.writelines(result)
                    print(result)
            except FileNotFoundError as e:
                print(f"File not found: {e}")
            except IOError as e:
                print(f"File I/O error: {e}")
            except Exception as e:
                print(f"An unexpected error occurred with files '{file1}' and '{file2}': {e}")
```

- **参数说明**:
  - `file_pairs`: 包含文件对的列表，每对为元组形式，包含两个文件路径。
  - `outputfile`: 输出结果的文件路径。

- **功能说明**:
  - 检查每对文件是否存在。
  - 读取文件内容，计算相似度。
  - 将相似度结果写入指定的输出文件。

#### 3. `TestCosineSimilarity` 类

##### 3.1 设计目的

`TestCosineSimilarity` 类用于对 `CosineSimilarity` 类进行单元测试，以确保其在各种情况下的正确性。

##### 3.2 测试用例

- **`test_empty_file`**:
  
  ```python
  def test_empty_file(self):
      sim = CosineSimilarity("", "")
      self.assertEqual(sim.main(), 0.0)
  ```

  - **说明**: 测试两个空文本的相似度是否为0。

- **`test_no_common_text`**:
  
  ```python
  def test_no_common_text(self):
      sim = CosineSimilarity("这是一个测试", "完全不同的内容")
      self.assertEqual(sim.main(), 0.0)
  ```

  - **说明**: 测试两个完全不同的文本的相似度是否为0。

- **`test_identical_files`**:
  
  ```python
  def test_identical_files(self):
      sim = CosineSimilarity("内容完全相同", "内容完全相同")
      self.assertEqual(sim.main(), 1.0)
  ```

  - **说明**: 测试两个完全相同的文本的相似度是否为1。

- **`test_partial_overlap`**:
  
  ```python
  def test_partial_overlap(self):
      sim = CosineSimilarity("内容完全相同", "内容相同的部分")
      self.assertAlmostEqual(sim.main(), 0.5, places=1)
  ```

  - **说明**: 测试部分重叠的文本的相似度。

- **`test_with_html`**:
  
  ```python
  def test_with_html(self):
      sim = CosineSimilarity("<p>这是一个测试</p>", "<div>这是一个测试</div>")
      self.assertEqual(sim.main(), 1.0)
  ```

  - **说明**: 测试包含HTML标签的文本的相似度。

- **`test_empty_document`**:
  
  ```python
  def test_empty_document(self):
      sim = CosineSimilarity("", "非空文档")
      self.assertEqual(sim.main(), 0.0)
  ```

  - **说明**: 测试一个空文本与非空文本的相似度。

- **`test_special_characters`**:
  
  ```python
  def test_special_characters(self):
      sim = CosineSimilarity("!@#$%^&*()", "@#$%^&*()!~")
      self.assertAlmostEqual(sim.main(), 0.2, places=1)
  ```

  - **说明**: 测试包含特殊字符的文本的相似度。

- **`test_large_text`**:
  
  ```python
  def test_large_text(self):
      large_text1 = "这是一个" * 1000
      large_text2 = "这是一个测试" * 1000
      sim = CosineSimilarity(large_text1, large_text2)
      self.assertAlmostEqual(sim.main(), 0.5, places=1)
  ```

  - **说明**: 测试非常大的文本的相似度。

- **`test_only_stop_words`**:
  
  ```python
  def test_only_stop_words(self):
      sim = CosineSimilarity("the the the", "and and and")
      self.assertEqual(sim.main(), 0.0)
  ```

  - **说明**: 测试仅包含停用词的文本的相似度。

- **`test_different_languages`**:
  
  ```python
  def test_different_languages(self):
      sim = CosineSimilarity("这是中文", "This is English")
      self.assertEqual(sim.main(), 0.0)
  ```

  - **说明**: 测试不同语言文本的相似度。

- **`test_very_similar_texts`**:
  
  ```python
  def test_very_similar_texts(self):
      sim = CosineSimilarity("This is a test.", "This is a test!")
      self.assertAlmostEqual(sim.main(), 0.9, places=1)
  ```
  
  - **说明**: 测试非常相似但不完全相同的文本的相似度。
